<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Datastar + OpenCode SSE Test</title>
  <script type="module" src="https://cdn.jsdelivr.net/gh/starfederation/datastar@1.0.0-RC.6/bundles/datastar.js"></script>
  <style>
    body { font-family: monospace; padding: 20px; max-width: 800px; margin: 0 auto; }
    pre { background: #f4f4f4; padding: 10px; overflow-x: auto; }
    button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    .status { padding: 10px; margin: 10px 0; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h1>Experiment 3: @get() Purist Approach</h1>
  <p>Testing if Datastar's @get() action can handle OpenCode's JSON SSE events</p>
  <p><strong>Hypothesis:</strong> @get() expects Datastar HTML patch events, so this will likely fail with JSON events.</p>

  <!-- Step 1: Create Session & Connect SSE with @get() -->
  <div data-signals="{sessionId: '', status: 'ready', events: [], postResponse: null, promptText: 'Hello from Datastar! What is 2+2?'}">

    <h2>Step 1: Create Session & Connect SSE (Purist Way)</h2>
    <button
      data-on:click="fetch('http://127.0.0.1:42992/session', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({title: 'Datastar Test'})}).then(r => r.json()).then(d => {$sessionId = d.id; $status = 'Session created: ' + d.id + ' | Attempting @get()...'; @get('http://127.0.0.1:42992/event')})">
      Create Session & Connect SSE
    </button>

    <div id="status" class="status">
      <strong>Status:</strong> <span data-text="$status"></span>
    </div>

    <div id="session-info" data-show="$sessionId !== ''">
      <strong>Session ID:</strong> <span data-text="$sessionId"></span>
    </div>

    <!-- Step 2: Send Prompt -->
    <div data-show="$sessionId !== ''">
      <h2>Step 2: Send Prompt</h2>
      <div>
        <label for="prompt-input"><strong>Your Prompt:</strong></label><br>
        <textarea id="prompt-input" data-bind="promptText" placeholder="Enter your prompt here..." style="width: 100%; min-height: 80px; padding: 8px; margin: 8px 0; font-family: monospace;">Hello from Datastar! What is 2+2?</textarea>
      </div>
      <button
        data-on:click="fetch('http://127.0.0.1:42992/session/' + $sessionId + '/message', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({parts: [{type: 'text', text: $promptText}]})}).then(r => {if (!r.ok) throw new Error('HTTP ' + r.status); return r.json()}).then(d => {$postResponse = d; $status = 'Prompt sent! Message ID: ' + d.info.id + ', Response: ' + (d.parts.find(p => p.type === 'text')?.text || 'Processing...')}).catch(e => {$status = 'Error: ' + e.message})">
        Send Prompt
      </button>

      <!-- POST Response Display -->
      <div data-show="$postResponse !== null">
        <h3>POST Response (Channel 1 - Immediate):</h3>
        <pre data-text="JSON.stringify($postResponse, null, 2)"></pre>
      </div>
    </div>

    <!-- Expected Results -->
    <div data-show="$sessionId !== ''">
      <h2>Expected Results</h2>
      <p><strong>What should happen:</strong> @get() opens SSE connection to /event endpoint</p>
      <p><strong>What will likely happen:</strong> Datastar expects 'datastar-patch-elements' events but OpenCode sends JSON events like 'message.updated'</p>
      <p><strong>Check browser console</strong> for errors or unexpected behavior</p>
    </div>

    <!-- Event Display -->
    <div id="events" data-show="$events.length > 0">
      <h3>Events Received (if any):</h3>
      <pre data-text="JSON.stringify($events, null, 2)"></pre>
    </div>

  </div>

  <hr>
  <h2>About This Test</h2>
  <ul>
    <li><strong>OpenCode API:</strong> http://127.0.0.1:42992</li>
    <li><strong>Datastar:</strong> Pure hypermedia approach (no frameworks)</li>
    <li><strong>SSE:</strong> OpenCode emits JSON events, Datastar normally expects HTML patches</li>
    <li><strong>This test:</strong> Shows raw SSE compatibility - both use text/event-stream</li>
  </ul>
</body>
</html>
